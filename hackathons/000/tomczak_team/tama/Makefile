# Tamagotchi Web App - Makefile

.PHONY: help serve dev install clean test lint format check-deps check-config restart stop

# Default target
help:
	@echo "Tamagotchi Web App - Available Commands:"
	@echo ""
	@echo "  serve     - Start production server on http://localhost:8000"
	@echo "  dev       - Start development server with auto-reload"
	@echo "  restart   - Stop any running server and start fresh"
	@echo "  stop      - Stop any running servers"
	@echo "  install   - Install/sync all dependencies"
	@echo "  clean     - Clean cache and temporary files"
	@echo "  test      - Run basic functionality tests"
	@echo "  lint      - Run code linting (if available)"
	@echo "  format    - Format code (if available)"
	@echo "  check-deps- Check if all dependencies are installed"
	@echo "  check-config - Verify configuration files"
	@echo ""

# Production server
serve: check-deps check-config
	@echo "ğŸš€ Starting Tamagotchi Web App..."
	@echo "ğŸ“ Access at: http://localhost:8000"
	@echo "ğŸ”„ Press Ctrl+C to stop"
	uv run uvicorn app.main:app --host 0.0.0.0 --port 8000

# Development server with auto-reload
dev: check-deps check-config
	@echo "ğŸ› ï¸  Starting development server..."
	@echo "ğŸ“ Access at: http://localhost:8000"
	@echo "ğŸ”„ Auto-reload enabled - Press Ctrl+C to stop"
	uv run uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Install dependencies
install:
	@echo "ğŸ“¦ Installing dependencies with UV..."
	uv sync
	@echo "âœ… Dependencies installed successfully"

# Clean temporary files
clean:
	@echo "ğŸ§¹ Cleaning temporary files..."
	rm -rf __pycache__
	rm -rf .pytest_cache
	rm -rf **/__pycache__
	rm -rf **/**/__pycache__
	rm -rf .coverage
	rm -rf htmlcov
	rm -rf dist
	rm -rf build
	rm -rf *.egg-info
	find . -name "*.pyc" -delete
	find . -name "*.pyo" -delete
	@echo "âœ… Cleanup complete"

# Basic functionality tests
test: check-deps
	@echo "ğŸ§ª Running basic functionality tests..."
	@echo "Testing imports..."
	@uv run python -c "from app.main import app; print('âœ… FastAPI app import successful')"
	@uv run python -c "from lib.game_logic import GameEngine; print('âœ… Game logic import successful')"
	@uv run python -c "from lib.llm_client import TamagotchiLLMClient; print('âœ… LLM client import successful')"
	@uv run python -c "from app.models.tamagotchi import TamagotchiState; print('âœ… Models import successful')"
	@echo "Testing configuration..."
	@make check-config
	@echo "âœ… Basic tests passed"

# Lint code (if linter is available)
lint:
	@echo "ğŸ” Running code linting..."
	@if command -v ruff >/dev/null 2>&1; then \
		echo "Running Ruff..."; \
		ruff check .; \
	elif uv run python -m flake8 --version >/dev/null 2>&1; then \
		echo "Running Flake8..."; \
		uv run python -m flake8 .; \
	else \
		echo "âš ï¸  No linter available (install ruff or flake8)"; \
	fi

# Format code (if formatter is available)
format:
	@echo "ğŸ¨ Formatting code..."
	@if command -v ruff >/dev/null 2>&1; then \
		echo "Formatting with Ruff..."; \
		ruff format .; \
	elif uv run python -m black --version >/dev/null 2>&1; then \
		echo "Formatting with Black..."; \
		uv run python -m black .; \
	else \
		echo "âš ï¸  No formatter available (install ruff or black)"; \
	fi

# Check dependencies
check-deps:
	@echo "ğŸ” Checking dependencies..."
	@if ! command -v uv >/dev/null 2>&1; then \
		echo "âŒ UV is not installed. Install from: https://docs.astral.sh/uv/"; \
		exit 1; \
	fi
	@echo "âœ… UV is installed"
	@if [ ! -f "uv.lock" ]; then \
		echo "âš ï¸  No uv.lock found. Run 'make install' first."; \
		exit 1; \
	fi
	@echo "âœ… Dependencies lock file found"

# Check configuration
check-config:
	@echo "ğŸ” Checking configuration..."
	@if [ ! -f "config.yml" ]; then \
		echo "âŒ config.yml not found"; \
		echo "Please create config.yml with your Azure OpenAI settings"; \
		exit 1; \
	fi
	@echo "âœ… config.yml found"
	@uv run python -c "import yaml; config=yaml.safe_load(open('config.yml')); \
		required=['azure-openai-api-key', 'azure-openai-endpoint', 'azure-openai-api-version', 'model']; \
		missing=[k for k in required if k not in config]; \
		assert not missing, f'Missing config keys: {missing}'; \
		print('âœ… Configuration valid')"

# Create .env template (optional)
create-env-template:
	@echo "ğŸ“ Creating .env template..."
	@echo "# Azure OpenAI Configuration" > .env.template
	@echo "AZURE_OPENAI_ENDPOINT=https://your-endpoint.openai.azure.com/" >> .env.template
	@echo "AZURE_OPENAI_KEY=your-api-key-here" >> .env.template
	@echo "AZURE_OPENAI_API_VERSION=2024-02-01" >> .env.template
	@echo "MODEL_NAME=gpt-4" >> .env.template
	@echo "" >> .env.template
	@echo "# Tamagotchi Settings" >> .env.template
	@echo "TAMAGOTCHI_UPDATE_INTERVAL=60" >> .env.template
	@echo "TAMAGOTCHI_SAVE_FILE=tamagotchi_save.json" >> .env.template
	@echo "" >> .env.template
	@echo "# Server Settings" >> .env.template
	@echo "HOST=0.0.0.0" >> .env.template
	@echo "PORT=8000" >> .env.template
	@echo "RELOAD=false" >> .env.template
	@echo "âœ… .env template created"
	@echo "ğŸ“‹ Copy .env.template to .env and fill in your values"

# Quick setup for new users
setup: install check-config
	@echo "ğŸ‰ Setup complete!"
	@echo "Run 'make serve' to start the Tamagotchi!"

# Show status
status:
	@echo "ğŸ“Š Tamagotchi Web App Status:"
	@echo ""
	@echo "Dependencies:"
	@make check-deps 2>/dev/null && echo "  âœ… UV and dependencies OK" || echo "  âŒ Missing dependencies"
	@echo ""
	@echo "Configuration:"
	@make check-config 2>/dev/null && echo "  âœ… config.yml OK" || echo "  âŒ config.yml issues"
	@echo ""
	@echo "Files:"
	@[ -f "tamagotchi_save.json" ] && echo "  ğŸ“ Save file exists" || echo "  ğŸ“ No save file (will create new Tamagotchi)"
	@[ -d "web" ] && echo "  ğŸŒ Web files present" || echo "  âŒ Missing web directory"
	@echo ""
	@echo "Ready to run: make serve"

# Development helpers
dev-reset: clean
	@echo "ğŸ”„ Resetting development environment..."
	@rm -f tamagotchi_save.json
	@echo "âœ… Development reset complete"

# Stop any running servers (helpful for development)
stop:
	@echo "ğŸ›‘ Stopping any running servers..."
	@pkill -f "uvicorn.*app.main:app" || echo "No running servers found"
	@echo "âœ… Servers stopped"

# Restart server (stop + serve)
restart: stop
	@echo "ğŸ”„ Restarting Tamagotchi Web App..."
	@sleep 2
	@make serve